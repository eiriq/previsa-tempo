<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Localização HTML5 - Máxima Precisão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes radar {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .radar-animation {
            position: relative;
        }
        
        .radar-animation::before,
        .radar-animation::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radar 2s infinite;
        }
        
        .radar-animation::after {
            animation-delay: 1s;
        }
        
        .location-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .map-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .map-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.05) 10px,
                rgba(255, 255, 255, 0.05) 20px
            );
            animation: slide 20s linear infinite;
        }
        
        @keyframes slide {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .accuracy-indicator {
            transition: all 0.3s ease;
        }
        
        .accuracy-excellent { background-color: #10b981; }
        .accuracy-good { background-color: #3b82f6; }
        .accuracy-fair { background-color: #f59e0b; }
        .accuracy-poor { background-color: #ef4444; }
        
        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                <i class="fas fa-map-marker-alt mr-3"></i>
                Teste de Localização - Máxima Precisão
            </h1>
            <p class="text-xl text-purple-100">
                Vamos encontrar sua localização com a maior precisão possível
            </p>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto">
            <!-- Tips Section -->
            <div class="location-card rounded-2xl p-6 shadow-2xl mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    Dicas para Melhor Precisão:
                </h3>
                <div class="grid md:grid-cols-2 gap-3 text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-wifi text-blue-500 mr-2 mt-0.5"></i>
                        <span>Conecte-se ao Wi-Fi</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-signal text-green-500 mr-2 mt-0.5"></i>
                        <span>Ative o GPS do dispositivo</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-window-maximize text-purple-500 mr-2 mt-0.5"></i>
                        <span>Use em área aberta</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-mobile-alt text-red-500 mr-2 mt-0.5"></i>
                        <span>Mantenha o celular visível</span>
                    </div>
                </div>
            </div>

            <!-- Map Visualization -->
            <div class="map-container rounded-2xl p-8 mb-8 relative">
                <div class="relative z-10 text-center">
                    <div class="radar-animation inline-block mb-4">
                        <i class="fas fa-crosshairs text-6xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-white mb-2">
                        Buscando Sua Localização Exata
                    </h2>
                    <p class="text-purple-100">
                        Vamos fazer várias tentativas para encontrar sua casa
                    </p>
                </div>
            </div>

            <!-- Test Buttons -->
            <div class="text-center mb-8">
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="testLocationBtn" 
                            class="bg-white text-purple-700 px-8 py-4 rounded-full font-semibold text-lg 
                                   hover:bg-purple-50 transform hover:scale-105 transition-all duration-300 
                                   shadow-2xl hover:shadow-purple-500/25">
                        <i class="fas fa-location-crosshairs mr-2"></i>
                        Iniciar Busca de Precisão Máxima
                    </button>
                    <button id="deviceDetailsBtn" 
                            class="bg-blue-600 text-white px-8 py-4 rounded-full font-semibold text-lg 
                                   hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 
                                   shadow-2xl hover:shadow-blue-500/25">
                        <i class="fas fa-desktop mr-2"></i>
                        Detalhes do Dispositivo
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- Loading State -->
                <div id="loadingState" class="location-card rounded-2xl p-8 shadow-2xl mb-6">
                    <div class="flex flex-col items-center justify-center">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-xl font-semibold text-gray-700 mb-2">
                            Buscando sua localização...
                        </p>
                        <p class="text-sm text-gray-500 mb-4">
                            Por favor, permita o acesso quando o navegador solicitar
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="attemptText" class="text-sm text-gray-600 mt-2">Tentativa 1 de 3</p>
                    </div>
                </div>

                <!-- Location Data -->
                <div id="locationData" class="hidden space-y-6">
                    <!-- Accuracy Indicator -->
                    <div class="location-card rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-bullseye text-purple-600 mr-3"></i>
                            Precisão da Localização
                        </h3>
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-lg font-semibold text-gray-700">Nível de Precisão:</span>
                            <span id="accuracyLevel" class="text-lg font-bold">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="accuracyBar" class="accuracy-indicator h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="accuracyDescription" class="text-sm text-gray-600 mt-2">--</p>
                    </div>

                    <!-- Coordinates Card -->
                    <div class="location-card rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-crosshairs text-purple-600 mr-3"></i>
                            Coordenadas Detalhadas
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-purple-600 font-semibold mb-1">Latitude</p>
                                <p id="latitude" class="text-2xl font-bold text-gray-800">--</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-blue-600 font-semibold mb-1">Longitude</p>
                                <p id="longitude" class="text-2xl font-bold text-gray-800">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info Card -->
                    <div class="location-card rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                            Informações Complementares
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Precisão (Raio de erro)</span>
                                <span id="accuracy" class="font-semibold text-gray-800">--</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Altitude</span>
                                <span id="altitude" class="font-semibold text-gray-800">Não disponível</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Velocidade</span>
                                <span id="speed" class="font-semibold text-gray-800">Não disponível</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Direção</span>
                                <span id="heading" class="font-semibold text-gray-800">Não disponível</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600">Horário da captura</span>
                                <span id="timestamp" class="font-semibold text-gray-800">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Map Link -->
                    <div class="location-card rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-map text-green-600 mr-3"></i>
                            Visualização no Mapa
                        </h3>
                        <div class="space-y-3">
                            <a id="mapLink" href="#" target="_blank" 
                               class="inline-flex items-center bg-green-500 text-white px-6 py-3 rounded-lg 
                                      hover:bg-green-600 transition-colors duration-300">
                                <i class="fas fa-external-link-alt mr-2"></i>
                                Abrir no Google Maps
                            </a>
                            <a id="streetViewLink" href="#" target="_blank" 
                               class="inline-flex items-center bg-orange-500 text-white px-6 py-3 rounded-lg 
                                      hover:bg-orange-600 transition-colors duration-300 ml-3">
                                <i class="fas fa-street-view mr-2"></i>
                                Street View
                            </a>
                        </div>
                    </div>

                    <!-- Improve Accuracy Button -->
                    <div class="location-card rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-redo text-purple-600 mr-3"></i>
                            Ainda não é sua casa?
                        </h3>
                        <p class="text-gray-600 mb-4">
                            Vamos tentar novamente com configurações diferentes para melhorar a precisão
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <button id="improveAccuracyBtn" 
                                    class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold 
                                           hover:bg-purple-700 transition-colors duration-300">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Melhorar Precisão
                            </button>
                            <button id="testAgainBtn" 
                                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold 
                                           hover:bg-blue-700 transition-colors duration-300">
                                <i class="fas fa-redo mr-2"></i>
                                Nova Busca
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden location-card rounded-2xl p-8 shadow-2xl">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Não foi possível obter localização</h3>
                        <p id="errorMessage" class="text-gray-600 mb-4">--</p>
                        <div class="space-x-4">
                            <button id="retryBtn" 
                                    class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold 
                                           hover:bg-red-600 transition-colors duration-300">
                                <i class="fas fa-redo mr-2"></i>
                                Tentar Novamente
                            </button>
                            <button id="resetBtn" 
                                    class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold 
                                           hover:bg-gray-600 transition-colors duration-300">
                                <i class="fas fa-home mr-2"></i>
                                Voltar ao Início
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Details Section -->
            <div id="deviceDetailsSection" class="hidden">
                <div class="location-card rounded-2xl p-8 shadow-2xl">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-desktop text-blue-600 mr-3"></i>
                        Detalhes do Dispositivo
                    </h3>
                    
                    <div id="deviceLoading" class="flex flex-col items-center justify-center mb-6">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-lg font-semibold text-gray-700">Coletando informações do dispositivo...</p>
                    </div>

                    <div id="deviceInfo" class="hidden device-info-grid">
                        <!-- IP Address -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-network-wired text-green-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Endereço IP</h4>
                            </div>
                            <p id="deviceIP" class="text-2xl font-bold text-gray-700">--</p>
                            <p class="text-sm text-gray-500 mt-1">IP Público</p>
                        </div>

                        <!-- Operating System -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-microchip text-purple-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Sistema Operacional</h4>
                            </div>
                            <p id="deviceOS" class="text-2xl font-bold text-gray-700">--</p>
                            <p id="deviceOSVersion" class="text-sm text-gray-500 mt-1">Versão</p>
                        </div>

                        <!-- Browser -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-globe text-blue-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Navegador</h4>
                            </div>
                            <p id="deviceBrowser" class="text-2xl font-bold text-gray-700">--</p>
                            <p id="deviceBrowserVersion" class="text-sm text-gray-500 mt-1">Versão</p>
                        </div>

                        <!-- Device Type -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-mobile-alt text-orange-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Tipo de Dispositivo</h4>
                            </div>
                            <p id="deviceType" class="text-2xl font-bold text-gray-700">--</p>
                            <p id="deviceModel" class="text-sm text-gray-500 mt-1">Modelo</p>
                        </div>

                        <!-- Screen Resolution -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-tv text-red-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Resolução de Tela</h4>
                            </div>
                            <p id="deviceScreen" class="text-2xl font-bold text-gray-700">--</p>
                            <p id="deviceViewport" class="text-sm text-gray-500 mt-1">Viewport</p>
                        </div>

                        <!-- Platform -->
                        <div class="info-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-cogs text-indigo-600 text-2xl mr-3"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Plataforma</h4>
                            </div>
                            <p id="devicePlatform" class="text-2xl font-bold text-gray-700">--</p>
                            <p id="deviceArchitecture" class="text-sm text-gray-500 mt-1">Arquitetura</p>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button id="closeDeviceDetails" 
                                class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold 
                                       hover:bg-gray-600 transition-colors duration-300">
                            <i class="fas fa-times mr-2"></i>
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-purple-100">
            <p class="text-sm">
                <i class="fas fa-code mr-2"></i>
                Demonstrando o poder do HTML5 com Geolocation API - Versão de Máxima Precisão
            </p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const testLocationBtn = document.getElementById('testLocationBtn');
        const deviceDetailsBtn = document.getElementById('deviceDetailsBtn');
        const resultsSection = document.getElementById('resultsSection');
        const deviceDetailsSection = document.getElementById('deviceDetailsSection');
        const loadingState = document.getElementById('loadingState');
        const locationData = document.getElementById('locationData');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const testAgainBtn = document.getElementById('testAgainBtn');
        const improveAccuracyBtn = document.getElementById('improveAccuracyBtn');
        const retryBtn = document.getElementById('retryBtn');
        const resetBtn = document.getElementById('resetBtn');
        const mapLink = document.getElementById('mapLink');
        const streetViewLink = document.getElementById('streetViewLink');
        const progressBar = document.getElementById('progressBar');
        const attemptText = document.getElementById('attemptText');
        const closeDeviceDetails = document.getElementById('closeDeviceDetails');

        // Device Details Elements
        const deviceLoading = document.getElementById('deviceLoading');
        const deviceInfo = document.getElementById('deviceInfo');
        const deviceIP = document.getElementById('deviceIP');
        const deviceOS = document.getElementById('deviceOS');
        const deviceOSVersion = document.getElementById('deviceOSVersion');
        const deviceBrowser = document.getElementById('deviceBrowser');
        const deviceBrowserVersion = document.getElementById('deviceBrowserVersion');
        const deviceType = document.getElementById('deviceType');
        const deviceModel = document.getElementById('deviceModel');
        const deviceScreen = document.getElementById('deviceScreen');
        const deviceViewport = document.getElementById('deviceViewport');
        const devicePlatform = document.getElementById('devicePlatform');
        const deviceArchitecture = document.getElementById('deviceArchitecture');

        // Location display elements
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const accuracyEl = document.getElementById('accuracy');
        const altitudeEl = document.getElementById('altitude');
        const speedEl = document.getElementById('speed');
        const headingEl = document.getElementById('heading');
        const timestampEl = document.getElementById('timestamp');
        const accuracyLevel = document.getElementById('accuracyLevel');
        const accuracyBar = document.getElementById('accuracyBar');
        const accuracyDescription = document.getElementById('accuracyDescription');

        // State variables
        let currentAttempt = 1;
        let maxAttempts = 3;
        let bestAccuracy = Infinity;
        let bestPosition = null;

        // Check if Geolocation API is available
        if (!navigator.geolocation) {
            showError('Seu navegador não suporta a Geolocation API.');
            testLocationBtn.disabled = true;
            testLocationBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Event Listeners
        testLocationBtn.addEventListener('click', startLocationSearch);
        deviceDetailsBtn.addEventListener('click', showDeviceDetails);
        testAgainBtn.addEventListener('click', startLocationSearch);
        improveAccuracyBtn.addEventListener('click', improveAccuracy);
        retryBtn.addEventListener('click', startLocationSearch);
        resetBtn.addEventListener('click', resetToStart);
        closeDeviceDetails.addEventListener('click', hideDeviceDetails);

        function startLocationSearch() {
            currentAttempt = 1;
            bestAccuracy = Infinity;
            bestPosition = null;
            getLocationWithRetry();
        }

        function getLocationWithRetry() {
            // Show loading state
            resultsSection.classList.remove('hidden');
            deviceDetailsSection.classList.add('hidden');
            loadingState.classList.remove('hidden');
            locationData.classList.add('hidden');
            errorState.classList.add('hidden');
            testLocationBtn.style.display = 'none';

            updateProgress();
            getLocation();
        }

        function updateProgress() {
            const progress = (currentAttempt / maxAttempts) * 100;
            progressBar.style.width = `${progress}%`;
            attemptText.textContent = `Tentativa ${currentAttempt} de ${maxAttempts}`;
        }

        function getLocation() {
            const options = {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handlePosition,
                handleError,
                options
            );
        }

        function handlePosition(position) {
            const accuracy = position.coords.accuracy;

            // Check if this is the best accuracy so far
            if (accuracy < bestAccuracy) {
                bestAccuracy = accuracy;
                bestPosition = position;
            }

            // If accuracy is good enough (< 50 meters) or we've tried enough times
            if (accuracy < 50 || currentAttempt >= maxAttempts) {
                showFinalPosition(bestPosition);
            } else {
                // Try again with different settings
                currentAttempt++;
                setTimeout(() => {
                    updateProgress();
                    getLocation();
                }, 1000);
            }
        }

        function handleError(error) {
            if (currentAttempt < maxAttempts) {
                currentAttempt++;
                setTimeout(() => {
                    updateProgress();
                    getLocation();
                }, 1000);
            } else {
                showError(error);
            }
        }

        function showFinalPosition(position) {
            loadingState.classList.add('hidden');
            locationData.classList.remove('hidden');

            const { latitude, longitude, accuracy, altitude, heading, speed } = position.coords;
            const timestamp = new Date(position.timestamp);

            // Update display
            latitudeEl.textContent = latitude.toFixed(6) + '°';
            longitudeEl.textContent = longitude.toFixed(6) + '°';
            accuracyEl.textContent = `±${Math.round(accuracy)} metros`;
            
            // Handle altitude
            if (altitude !== null) {
                altitudeEl.textContent = `${Math.round(altitude)} metros`;
                altitudeEl.classList.remove('text-gray-400');
            } else {
                altitudeEl.textContent = 'Não disponível';
                altitudeEl.classList.add('text-gray-400');
            }

            // Handle speed
            if (speed !== null) {
                speedEl.textContent = `${Math.round(speed * 3.6)} km/h`;
                speedEl.classList.remove('text-gray-400');
            } else {
                speedEl.textContent = 'Não disponível';
                speedEl.classList.add('text-gray-400');
            }

            // Handle heading
            if (heading !== null) {
                headingEl.textContent = `${Math.round(heading)}°`;
                headingEl.classList.remove('text-gray-400');
            } else {
                headingEl.textContent = 'Não disponível';
                headingEl.classList.add('text-gray-400');
            }

            timestampEl.textContent = timestamp.toLocaleString('pt-BR');

            // Update accuracy indicator
            updateAccuracyIndicator(accuracy);

            // Update map links
            mapLink.href = `https://www.google.com/maps?q=${latitude},${longitude}`;
            streetViewLink.href = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${latitude},${longitude}`;

            // Show success animation
            locationData.style.opacity = '0';
            locationData.style.transform = 'translateY(20px)';
            setTimeout(() => {
                locationData.style.transition = 'all 500ms ease-out';
                locationData.style.opacity = '1';
                locationData.style.transform = 'translateY(0)';
            }, 100);
        }

        function updateAccuracyIndicator(accuracy) {
            let level, description, percentage, className;

            if (accuracy < 10) {
                level = 'Excelente';
                description = 'Precisão de nível GPS - muito próximo da sua localização exata!';
                percentage = 100;
                className = 'accuracy-excellent';
            } else if (accuracy < 50) {
                level = 'Muito Boa';
                description = 'Precisão alta - provavelmente muito perto da sua localização';
                percentage = 80;
                className = 'accuracy-good';
            } else if (accuracy < 100) {
                level = 'Boa';
                description = 'Precisão moderada - pode estar a alguns quarteirões de distância';
                percentage = 60;
                className = 'accuracy-fair';
            } else {
                level = 'Regular';
                description = 'Precisão baixa - baseada em Wi-Fi ou rede celular';
                percentage = 30;
                className = 'accuracy-poor';
            }

            accuracyLevel.textContent = level;
            accuracyDescription.textContent = description;
            accuracyBar.style.width = `${percentage}%`;
            accuracyBar.className = `accuracy-indicator h-4 rounded-full transition-all duration-500 ${className}`;
        }

        function improveAccuracy() {
            // Reset and try with even more aggressive settings
            currentAttempt = 1;
            bestAccuracy = Infinity;
            bestPosition = null;
            maxAttempts = 5; // More attempts
            
            resultsSection.classList.remove('hidden');
            deviceDetailsSection.classList.add('hidden');
            loadingState.classList.remove('hidden');
            locationData.classList.add('hidden');
            errorState.classList.add('hidden');
            
            updateProgress();
            
            // Wait a moment before trying again
            setTimeout(() => {
                getLocation();
            }, 2000);
        }

        function showError(error) {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');

            let message;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Você negou o acesso à sua localização. Por favor, permita o acesso para continuar.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "As informações de localização não estão disponíveis. Verifique sua conexão ou tente novamente.";
                    break;
                case error.TIMEOUT:
                    message = "A requisição de localização expirou. Verifique sua conexão com a internet e tente novamente.";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Ocorreu um erro desconhecido ao obter sua localização.";
                    break;
                default:
                    message = "Não foi possível obter sua localização. Tente novamente.";
            }
            
            errorMessage.textContent = message;
        }

        function resetToStart() {
            resultsSection.classList.add('hidden');
            testLocationBtn.style.display = 'inline-flex';
            currentAttempt = 1;
            maxAttempts = 3;
        }

        // Device Details Functions
        async function showDeviceDetails() {
            resultsSection.classList.add('hidden');
            deviceDetailsSection.classList.remove('hidden');
            deviceLoading.classList.remove('hidden');
            deviceInfo.classList.add('hidden');

            try {
                // Get IP Address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                deviceIP.textContent = ipData.ip;

                // Get device information using modern APIs
                await getDeviceInfo();

                // Hide loading and show info
                deviceLoading.classList.add('hidden');
                deviceInfo.classList.remove('hidden');

            } catch (error) {
                console.error('Error getting device details:', error);
                deviceIP.textContent = 'Não disponível';
                await getDeviceInfo();
                deviceLoading.classList.add('hidden');
                deviceInfo.classList.remove('hidden');
            }
        }

        async function getDeviceInfo() {
            // Get basic browser info
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            
            // Get screen info
            const screenResolution = `${screen.width} × ${screen.height}`;
            const viewportSize = `${window.innerWidth} × ${window.innerHeight}`;
            
            deviceScreen.textContent = screenResolution;
            deviceViewport.textContent = viewportSize;
            devicePlatform.textContent = platform;

            // Try to get more detailed info using User-Agent Client Hints (modern API)
            if (navigator.userAgentData) {
                try {
                    const highEntropyValues = await navigator.userAgentData.getHighEntropyValues([
                        'platform',
                        'platformVersion',
                        'architecture',
                        'model',
                        'uaFullVersion'
                    ]);
                    
                    devicePlatform.textContent = highEntropyValues.platform || platform;
                    deviceArchitecture.textContent = highEntropyValues.architecture || 'Não disponível';
                    deviceModel.textContent = highEntropyValues.model || 'Não disponível';
                    
                    // Get browser info from userAgentData
                    const brands = navigator.userAgentData.brands;
                    if (brands && brands.length > 0) {
                        const mainBrand = brands[brands.length - 1]; // Usually the main browser
                        deviceBrowser.textContent = mainBrand.brand;
                        deviceBrowserVersion.textContent = mainBrand.version;
                    }
                } catch (error) {
                    console.log('User-Agent Client Hints not fully supported');
                    parseUserAgentFallback();
                }
            } else {
                parseUserAgentFallback();
            }

            // Detect device type
            detectDeviceType();
        }

        function parseUserAgentFallback() {
            const userAgent = navigator.userAgent.toLowerCase();
            
            // Detect OS
            let os = 'Desconhecido';
            let osVersion = '';
            
            if (userAgent.includes('windows')) {
                os = 'Windows';
                if (userAgent.includes('windows 10')) osVersion = '10';
                else if (userAgent.includes('windows 11')) osVersion = '11';
                else if (userAgent.includes('windows nt 6.3')) osVersion = '8.1';
                else if (userAgent.includes('windows nt 6.2')) osVersion = '8';
                else if (userAgent.includes('windows nt 6.1')) osVersion = '7';
            } else if (userAgent.includes('mac os') || userAgent.includes('macos')) {
                os = 'macOS';
                const macMatch = userAgent.match(/mac os x (\d+[._]\d+)/);
                if (macMatch) osVersion = macMatch[1].replace('_', '.');
            } else if (userAgent.includes('linux')) {
                os = 'Linux';
                if (userAgent.includes('android')) {
                    os = 'Android';
                    const androidMatch = userAgent.match(/android (\d+\.?\d*)/);
                    if (androidMatch) osVersion = androidMatch[1];
                }
            } else if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                os = 'iOS';
                const iosMatch = userAgent.match(/os (\d+_\d+)/);
                if (iosMatch) osVersion = iosMatch[1].replace('_', '.');
            }
            
            deviceOS.textContent = os;
            deviceOSVersion.textContent = osVersion || 'Não disponível';

            // Detect Browser
            let browser = 'Desconhecido';
            let browserVersion = '';
            
            if (userAgent.includes('chrome') && !userAgent.includes('edg')) {
                browser = 'Chrome';
                const chromeMatch = userAgent.match(/chrome\/(\d+\.?\d*)/);
                if (chromeMatch) browserVersion = chromeMatch[1];
            } else if (userAgent.includes('firefox')) {
                browser = 'Firefox';
                const firefoxMatch = userAgent.match(/firefox\/(\d+\.?\d*)/);
                if (firefoxMatch) browserVersion = firefoxMatch[1];
            } else if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
                browser = 'Safari';
                const safariMatch = userAgent.match(/version\/(\d+\.?\d*)/);
                if (safariMatch) browserVersion = safariMatch[1];
            } else if (userAgent.includes('edg')) {
                browser = 'Edge';
                const edgeMatch = userAgent.match(/edg\/(\d+\.?\d*)/);
                if (edgeMatch) browserVersion = edgeMatch[1];
            } else if (userAgent.includes('opera')) {
                browser = 'Opera';
                const operaMatch = userAgent.match(/opera\/(\d+\.?\d*)/);
                if (operaMatch) browserVersion = operaMatch[1];
            }
            
            if (!deviceBrowser.textContent || deviceBrowser.textContent === '--') {
                deviceBrowser.textContent = browser;
                deviceBrowserVersion.textContent = browserVersion || 'Não disponível';
            }
        }

        function detectDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            let deviceType = 'Desktop';
            let model = 'Não disponível';

            if (userAgent.includes('mobile')) {
                deviceType = 'Mobile';
            } else if (userAgent.includes('tablet')) {
                deviceType = 'Tablet';
            } else if (userAgent.includes('ipad')) {
                deviceType = 'Tablet';
                model = 'iPad';
            } else if (userAgent.includes('iphone')) {
                deviceType = 'Mobile';
                model = 'iPhone';
            } else if (userAgent.includes('android')) {
                deviceType = userAgent.includes('mobile') ? 'Mobile' : 'Tablet';
                // Try to get device model
                const androidMatch = userAgent.match(/android.*;\s*([^;)]*)/);
                if (androidMatch && androidMatch[1]) {
                    model = androidMatch[1].trim();
                }
            }

            // Check screen size for additional hints
            if (window.innerWidth <= 768) {
                deviceType = 'Mobile';
            } else if (window.innerWidth <= 1024) {
                deviceType = 'Tablet';
            } else {
                deviceType = 'Desktop';
            }

            deviceType.textContent = deviceType;
            if (!deviceModel.textContent || deviceModel.textContent === '--') {
                deviceModel.textContent = model;
            }
        }

        function hideDeviceDetails() {
            deviceDetailsSection.classList.add('hidden');
            testLocationBtn.style.display = 'inline-flex';
        }

        // Add smooth scroll behavior
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html>
